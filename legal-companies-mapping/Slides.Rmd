---
title: "Картографирование малых и средних предприятий в России"
output: powerpoint_presentation
author: "Сёмин Павел Олегович, аспирант ПГНИУ"
date: "14.03.2024"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(knitr)
```

```{r imports, cache = TRUE, include = FALSE}
source("helpers/Plots.R")
```

# Постановка задачи

- Показать на карте все российские малые и средние предприятия (МСП).
- Вариант: фильтр по по ОКВЭД для выбора конкретной сферы деятельности.
- Практическая применимость: как часть анализа данных и как визуализация.

# Проблема с данными

- ЕГРЮЛ — нет прямого доступа к базе, нет координат.
- Яндекс/2ГИС/Spark — платно (бесплатный парсинг затруднён).
- OSM — неполные данные, сложный формат выгрузок.

# Реестр МСП

- Доступен в открытых данных ФНС.
- Есть ИНН, адрес регистрации до населённого пункта, коды ОКВЭД.
- Можно объединять с другими наборами открытых данных по ИНН (доходы/расходы, работники).
- Сложно обработать (многоуровневый XML, объём 2Тб, если распаковать), нужно геокодировать адреса.

# Обработка реестра МСП

- Консольное приложение на Python.
- Загрузка → Распаковка и фильтрация → Агрегация → Геокодирование.
- Агрегация убирает дубли (выгрузки идут ежемесячно в полном виде).
- Геокодирование на базе справочных таблиц даёт нормализованные адреса + координаты (распознано 97% адресов).

# Преобразованный набор данных (пример)

```{r dataset-sample}
smb_data %>% 
    filter(
    start_date <= "2021-12-31",
    end_date >= "2021-12-31"
  ) %>% 
  select(tin, settlement, lon, lat) %>% 
  slice_head(n = 10) %>% 
  knitr::kable(
    col.names = c("ИНН", "Населённый пункт", "Долгота", "Широта"))
```

# Тестирование

- Только юридические компании (это демонстрационный вариант, программа позволяет показать любые).
- 2021 год.
- Вся Россия.
- Число фирм, прибыль, число работников.

# Россия, число фирм

```{r russia-legal-firms-count}
settlements_map
```

# Россия, прибыль

```{r russia-legal-firms-profit}
settlements_map_profit
```

# Россия, число работников

```{r russia-legal-firms-empl}
settlements_map_empl
```

# Выводы

- Разработано приложение, которое из открытых данных ФНС делает набор данных о МСП в России, готовый для картографирования.
- Подготовлены демонстрационные карты, сделанные с помощью полученного набора данных.
