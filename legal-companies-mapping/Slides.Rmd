---
title: "Картографирование малых и средних предприятий в России"
output: powerpoint_presentation
author: "Сёмин Павел Олегович, аспирант ПГНИУ"
date: "14.03.2024"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(knitr)
```

```{r imports, cache = TRUE, include = FALSE}
source("helpers/Plots.R")
```

# Задача

- Показать на карте российские малые и средние предприятия (МСП)
- Варианты: все сразу или в определённой сфере деятельности (по ОКВЭД)
- Зачем: как часть анализа данных и как визуализация

# Проблема: нет данных

- ЕГРЮЛ — нет прямого доступа ко всей базе, нет координат
- Яндекс/2ГИС — либо за деньги, либо незаконно парсить
- OSM — неполные данные, сложный формат выгрузок
- Реестр МСП — большой, в сложном формате, без координат, зато бесплатный и полностью доступный

# Реестр МСП

- Доступен в открытых данных ФНС
- 200 Гб в сжатом виде за 2016–2023
- Есть ИНН, адрес регистрации до населённого пункта, коды ОКВЭД
- Можно объединять с другими наборами открытых данных по ИНН (доходы/расходы, работники)
- Сложно обработать (многоуровневый XML в архивах, 2 Тб в распакованном виде), нужно геокодировать адреса, чтобы получить координаты

# Обработка реестра МСП

- Разработано консольное приложение на Python
- Загрузка → Извлечение → Агрегация → Геокодирование
- Агрегация убирает дубли (выгрузки идут ежемесячно в полном виде)
- Геокодирование на базе справочных таблиц → нормализованные адреса + координаты фирм с точностью до населённого пункта (распознано 97% адресов)

# Преобразованный набор данных

```{r dataset-sample}
smb_data %>% 
    filter(
    start_date <= "2021-12-31",
    end_date >= "2021-12-31"
  ) %>% 
  select(tin, settlement, lon, lat) %>% 
  slice_head(n = 10) %>% 
  knitr::kable(
    col.names = c("ИНН", "Населённый пункт", "Долгота", "Широта"))
```

# Тестирование

- Вместо всех фирм — только юридические (так быстрее)
- 2021 год
- Вся Россия
- Число фирм, дохода/расходы, число работников

# Россия, число фирм

```{r russia-legal-firms-count}
settlements_map
```

# Россия, прибыль

```{r russia-legal-firms-profit}
settlements_map_profit
```

# Россия, число работников

```{r russia-legal-firms-empl}
settlements_map_empl
```

# Выводы

- Разработана программа, которая из открытых данных ФНС делает набор данных, готовый для картографирования
- Продемонстрирована её работа
